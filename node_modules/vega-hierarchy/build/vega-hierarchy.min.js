!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-dataflow"),require("vega-util"),require("d3-collection"),require("d3-hierarchy")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-util","d3-collection","d3-hierarchy"],t):t(e.vega=e.vega||{},e.vega,e.vega,e.d3,e.d3)}(this,function(e,t,r,a,n){"use strict";function i(e){t.Transform.call(this,null,e)}function o(e){return e.values}function d(e){t.Transform.call(this,null,e)}function s(e){t.Transform.call(this,{},e)}function u(e){var r;return e.parent&&(r=e.parent.data)&&null!=t.tupleid(r)&&r}function p(e){var t=e||"tidy";return x.hasOwnProperty(t)?x[t]():void r.error("Unrecognized Tree layout method: "+t)}function l(){var e=n.treemap();return e.ratio=function(t){var r=e.tile();r.ratio&&e.tile(r.ratio(t))},e.method=function(t){T.hasOwnProperty(t)?e.tile(T[t]):r.error("Unrecognized Treemap layout method: "+t)},e}function f(e){t.Transform.call(this,null,e)}function m(e,t,r){for(var a,n=0,i=t.length;n<i;++n)a=t[n],a in r&&e[a](r[a])}function y(e,t,r){for(var a=e.data,n=0,i=t.length-1;n<i;++n)a[r[n]]=e[t[n]];a[r[i]]=e.children?e.children.length:0}function c(e){f.call(this,e)}function h(e){f.call(this,e)}function g(e){f.call(this,e)}function v(e){f.call(this,e)}var b=r.inherits(i,t.Transform);b.transform=function(e,i){i.source||r.error("Nest transform requires an upstream data source.");var d,s,u,p,l=e.key||t.tupleid;return(!this.value||(p=e.modified())||i.changed())&&(d=r.array(e.keys).reduce(function(e,t){return e.key(t),e},a.nest()).entries(i.source),s=n.hierarchy({values:d},o),u=s.lookup={},s.each(function(e){null!=t.tupleid(e.data)&&(u[l(e.data)]=e)}),this.value=s),i.source.root=this.value,p?i.fork(i.ALL):i};var k=r.inherits(d,t.Transform);k.transform=function(e,t){t.source||r.error("Stratify transform requires an upstream data source.");var a,i,o=e.modified(),d=!this.value||o||t.changed(t.ADD_REM)||t.modified(e.key.fields)||t.modified(e.parentKey.fields);return d&&(a=n.stratify().id(e.key).parentId(e.parentKey)(t.source),i=a.lookup={},a.each(function(t){i[e.key(t.data)]=t}),this.value=a),t.source.root=this.value,o?t.fork(t.ALL):t};var q=r.inherits(s,t.Transform);q.transform=function(e,a){function n(e){var t=d[e];t&&(p[e]=1,l.mod.push(t))}a.source&&a.source.root||r.error("TreeLinks transform requires a backing tree data source.");var i=a.source.root,o=i.lookup,d=this.value,s=e.key||t.tupleid,p={},l=a.fork();return a.visit(a.REM,function(e){var t=s(e),r=d[t];r&&(delete d[t],l.rem.push(r))}),a.visit(a.ADD,function(e){var r,a=s(e);(r=u(o[a]))&&(l.add.push(d[a]=t.ingest({source:r,target:e})),p[a]=1)}),a.visit(a.MOD,function(e){var t=s(e),r=o[t],a=r.children;if(n(t),a)for(var i=0,d=a.length;i<d;++i)p[t=s(a[i].data)]||n(t)}),l};var T={binary:n.treemapBinary,dice:n.treemapDice,slice:n.treemapSlice,slicedice:n.treemapSliceDice,squarify:n.treemapSquarify,resquarify:n.treemapResquarify},x={tidy:n.tree,cluster:n.cluster},z=r.inherits(f,t.Transform);z.transform=function(e,t){t.source&&t.source.root||r.error(this.constructor.name+" transform requires a backing tree data source.");var a=this.layout(e.method),n=this.fields,i=t.source.root,o=e.as||n;e.field&&i.sum(e.field),e.sort&&i.sort(e.sort),m(a,this.params,e);try{this.value=a(i)}catch(e){r.error(e)}return i.each(function(e){y(e,n,o)}),t.reflow(e.modified()).modifies(o).modifies("leaf")},r.inherits(c,f),c.prototype.layout=p,c.prototype.params=["size","nodeSize","separation"],c.prototype.fields=["x","y","depth","children"],r.inherits(h,f),h.prototype.layout=l,h.prototype.params=["method","ratio","size","round","padding","paddingInner","paddingOuter","paddingTop","paddingRight","paddingBottom","paddingLeft"],h.prototype.fields=["x0","y0","x1","y1","depth","children"],r.inherits(g,f),g.prototype.layout=n.partition,g.prototype.params=["size","round","padding"],g.prototype.fields=h.prototype.fields,r.inherits(v,f),v.prototype.layout=n.pack,v.prototype.params=["size","padding"],v.prototype.fields=["x","y","r","depth","children"];var L={type:"Nest",metadata:{treesource:!0},params:[{name:"keys",type:"field",array:!0},{name:"key",type:"field"}]},D={type:"Stratify",metadata:{treesource:!0},params:[{name:"key",type:"field",required:!0},{name:"parentKey",type:"field",required:!0}]},S={type:"TreeLinks",metadata:{tree:!0,generates:!0,changes:!0},params:[{name:"key",type:"field"}]},O={type:"Pack",metadata:{tree:!0,modifies:!0},params:[{name:"field",type:"field"},{name:"sort",type:"compare"},{name:"padding",type:"number",default:0},{name:"radius",type:"field",default:null},{name:"size",type:"number",array:!0,length:2},{name:"as",type:"string",array:!0,length:3,default:["x","y","r","depth","children"]}]},w={type:"Partition",metadata:{tree:!0,modifies:!0},params:[{name:"field",type:"field"},{name:"sort",type:"compare"},{name:"padding",type:"number",default:0},{name:"round",type:"boolean",default:!1},{name:"size",type:"number",array:!0,length:2},{name:"as",type:"string",array:!0,length:4,default:["x0","y0","x1","y1","depth","children"]}]},P={type:"Tree",metadata:{tree:!0,modifies:!0},params:[{name:"field",type:"field"},{name:"sort",type:"compare"},{name:"method",type:"enum",default:"tidy",values:["tidy","cluster"]},{name:"size",type:"number",array:!0,length:2},{name:"nodeSize",type:"number",array:!0,length:2},{name:"as",type:"string",array:!0,length:4,default:["x","y","depth","children"]}]},R={type:"Treemap",metadata:{tree:!0,modifies:!0},params:[{name:"field",type:"field"},{name:"sort",type:"compare"},{name:"method",type:"enum",default:"squarify",values:["squarify","resquarify","binary","dice","slice","slicedice"]},{name:"padding",type:"number",default:0},{name:"paddingInner",type:"number",default:0},{name:"paddingOuter",type:"number",default:0},{name:"paddingTop",type:"number",default:0},{name:"paddingRight",type:"number",default:0},{name:"paddingBottom",type:"number",default:0},{name:"paddingLeft",type:"number",default:0},{name:"ratio",type:"number",default:1.618033988749895},{name:"round",type:"boolean",default:!1},{name:"size",type:"number",array:!0,length:2},{name:"as",type:"string",array:!0,length:4,default:["x0","y0","x1","y1","depth","children"]}]};t.register(L,i),t.register(D,d),t.register(S,s),t.register(O,v),t.register(w,g),t.register(P,c),t.register(R,h),e.transform=t.transform,e.definition=t.definition,Object.defineProperty(e,"__esModule",{value:!0})});