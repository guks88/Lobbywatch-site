!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("vega-dataflow"),require("vega-scenegraph"),require("vega-util"),require("d3-array"),require("vega-parser"),require("vega-runtime")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-scenegraph","vega-util","d3-array","vega-parser","vega-runtime"],n):n(e.vega=e.vega||{},e.vega,e.vega,e.vega,e.d3,e.vega,e.vega)}(this,function(e,n,t,r,i,a,o){"use strict";function u(e){n.Transform.call(this,null,e)}function s(e,n,t){return e.bounds_prev.clear().union(e.bounds),n(e.bounds.clear(),e,t)}function d(e){n.Transform.call(this,null,e)}function h(e){var n=e.groups,t=e.parent;return n&&1===n.size?n.get(Object.keys(n.object)[0]):n&&t?n.lookup(t):null}function c(e){n.Transform.call(this,null,e)}function l(e){n.Transform.call(this,null,e)}function f(e,n,r){var i,a,o,u,s,d=n.items,h=Math.max(0,n.width||0),c=Math.max(0,n.height||0),l=(new t.Bounds).set(0,0,h,c),f=l.clone(),v=[];for(u=0,s=d.length;u<s;++u)switch(i=d[u],i.role){case re:o=p(e,i,h,c),(g(i)?f:l).union(o);break;case ae:v.push(i);break;case ie:case oe:f.union(i.bounds);break;default:l.union(i.bounds)}if(v.length)for(a={left:0,right:0,margin:r.legendMargin||8},u=0,s=v.length;u<s;++u)o=_(e,v[u],a,f,h,c),r.autosize&&r.autosize.type===ee?l.add(o.x1,0).add(o.x2,0):l.union(o);b(e,n,l.union(f),r)}function g(e){var n=e.items[0].datum.orient;return"left"===n||"right"===n}function v(e){var n=+e.grid;return[e.ticks?n++:-1,e.labels?n++:-1,n+ +e.domain]}function p(e,n,r,i){var a,o,u=n.items[0],s=u.datum,d=s.orient,h=v(s),c=u.range,l=u.offset,f=u.position,g=u.minExtent,p=u.maxExtent,_=s.title&&u.items[h[2]].items[0],b=u.titlePadding,y=_?_.fontSize+b:0,k=u.bounds,x=0,w=0;switch(k.clear(),(a=h[0])>-1&&k.union(u.items[a].bounds),(a=h[1])>-1&&k.union(u.items[a].bounds),d){case"top":x=f||0,w=-l,o=Math.max(g,Math.min(p,-k.y1)),_&&(_.auto?(_.y=-(b+o),o+=y):k.union(_.bounds)),k.add(0,-o).add(c,0);break;case"left":x=-l,w=f||0,o=Math.max(g,Math.min(p,-k.x1)),_&&(_.auto?(_.x=-(b+o),o+=y):k.union(_.bounds)),k.add(-o,0).add(0,c);break;case"right":x=r+l,w=f||0,o=Math.max(g,Math.min(p,k.x2)),_&&(_.auto?(_.x=b+o,o+=y):k.union(_.bounds)),k.add(0,0).add(o,c);break;case"bottom":x=f||0,w=i+l,o=Math.max(g,Math.min(p,k.y2)),_&&(_.auto?(_.y=b+o,o+=y):k.union(_.bounds)),k.add(0,0).add(c,o);break;default:x=u.x,w=u.y}return m(u,"x",x+.5)|m(u,"y",w+.5)&&e.enqueue([u]),t.boundStroke(k.translate(x,w),u),u.mark.bounds.clear().union(k),k}function m(e,n,t){return e[n]===t?0:(e[n]=t,1)}function _(e,n,r,i,a,o){var u,s,d=n.items[0],h=d.datum,c=h.orient,l=d.offset,f=d.bounds.clear(),g=0,v=r[c]||0;switch(d.items.forEach(function(e){f.union(e.bounds)}),u=Math.round(f.width())+2*d.padding-1,s=Math.round(f.height())+2*d.padding-1,c){case"left":g-=u+l-Math.floor(i.x1),r.left+=s+r.margin;break;case"right":g+=l+Math.ceil(i.x2),r.right+=s+r.margin;break;case"top-left":g+=l,v+=l;break;case"top-right":g+=a-u-l,v+=l;break;case"bottom-left":g+=l,v+=o-s-l;break;case"bottom-right":g+=a-u-l,v+=o-s-l;break;default:g=d.x,v=d.y}return m(d,"x",g)|m(d,"width",u)|m(d,"y",v)|m(d,"height",s)&&e.enqueue([d]),t.boundStroke(f.set(g,v,g+u,v+s),d),d.mark.bounds.clear().union(f),f}function b(e,n,t,r){var i=r.autosize&&r.autosize.type,a=r.autosize&&r.autosize.resize,o=e._width,u=e._height;if(!(e._autosize<1)&&i){var s=Math.max(0,n.width||0),d=Math.max(0,Math.ceil(-t.x1)),h=Math.max(0,Math.ceil(t.x2-s)),c=Math.max(0,n.height||0),l=Math.max(0,Math.ceil(-t.y1)),f=Math.max(0,Math.ceil(t.y2-c));i===te?(o=s,u=c,d=0,l=0):i===ee?(s=Math.max(0,o-d-h),c=Math.max(0,u-l-f)):i===ne&&(o=s+d+h,u=c+l+f),e.autosize(o,u,s,c,[d,l],a)}}function y(e){"undefined"!=typeof document&&document.body&&(document.body.style.cursor=e)}function k(e,n){var t=e._runtime.data;return t.hasOwnProperty(n)||e.error("Unrecognized data set: "+n),t[n]}function x(e){return k(this,e).values.value}function w(e,t){n.isChangeSet(t)||this.error("Second argument to changes must be a changeset.");var r=k(this,e);return r.modified=!0,this.pulse(r.input,t)}function z(e,t){return w.call(this,e,n.changeset().insert(t))}function M(e,t){return w.call(this,e,n.changeset().remove(t))}function T(e){var n=e.padding();return Math.max(0,e._width+n.left+n.right)}function E(e){var n=e.padding();return Math.max(0,e._height+n.top+n.bottom)}function S(e){var n=e.padding(),t=e._origin;return[n.left+t[0],n.top+t[1]]}function C(e){var n=S(e);e._renderer.background(e._background),e._renderer.resize(T(e),E(e),n),e._handler.origin(n)}function L(e,n,t){function i(e){var t,r=o;if(e)for(t=n;t;t=t.mark.group)if(t.mark.name===e){r=t;break}return r&&r.mark&&r.mark.interactive?r:{}}function a(e){if(!e)return t;r.isString(e)&&(e=i(e));for(var n=t.slice();e;)n[0]-=e.x||0,n[1]-=e.y||0,e=e.mark&&e.mark.group;return n}var o=n?"group"===n.mark.marktype?n:n.mark.group:null;return{view:r.constant(e),item:r.constant(n||{}),group:i,xy:a,x:function(e){return a(e)[0]},y:function(e){return a(e)[1]}}}function q(e){return e.item}function D(e){var n=e.item.mark.source;return n.source||n}function A(e){return function(n,t){return t.vega.view().changeset().encode(t.item,e)}}function R(e,n,t,r){var i=pe("div",{class:me});i.appendChild(pe("span",{class:_e},t.name||t.signal)),n.appendChild(i);var a=O;switch(t.input){case"checkbox":a=U;break;case"select":a=P;break;case"radio":a=j;break;case"range":a=H}a(e,i,t,r)}function O(e,n,t,r){var i=pe("input");for(var a in t)"signal"!==a&&"element"!==a&&i.setAttribute("input"===a?"type":a,t[a]);i.setAttribute("name",t.signal),i.setAttribute("value",r),n.appendChild(i),i.addEventListener("input",function(){e.update(i.value)}),e.elements=[i],e.set=function(e){i.value=e}}function U(e,n,t,r){var i={type:"checkbox",name:t.signal};r&&(i.checked=!0);var a=pe("input",i);n.appendChild(a),a.addEventListener("change",function(){e.update(a.checked)}),e.elements=[a],e.set=function(e){a.checked=!!e||null}}function P(e,n,t,r){var i=pe("select",{name:t.signal});t.options.forEach(function(e){var n={value:e};V(e,r)&&(n.selected=!0),i.appendChild(pe("option",n,e+""))}),n.appendChild(i),i.addEventListener("change",function(){e.update(t.options[i.selectedIndex])}),e.elements=[i],e.set=function(e){for(var n=0,r=t.options.length;n<r;++n)if(V(t.options[n],e))return void(i.selectedIndex=n)}}function j(e,n,t,r){var i=pe("span",{class:be});n.appendChild(i),e.elements=t.options.map(function(n){var a=ye+t.signal+"-"+n,o={id:a,type:"radio",name:t.signal,value:n};V(n,r)&&(o.checked=!0);var u=pe("input",o);return u.addEventListener("change",function(){e.update(n)}),i.appendChild(u),i.appendChild(pe("label",{for:a},n+"")),u}),e.set=function(n){for(var t=e.elements,r=0,i=t.length;r<i;++r)V(t[r].value,n)&&(t[r].checked=!0)}}function H(e,n,t,r){function a(){h.textContent=d.value,e.update(+d.value)}r=void 0!==r?r:(+t.max+ +t.min)/2;var o=t.min||Math.min(0,+r)||0,u=t.max||Math.max(100,+r)||100,s=t.step||i.tickStep(o,u,100),d=pe("input",{type:"range",value:r,name:t.signal,min:o,max:u,step:s}),h=pe("label",{},+r);n.appendChild(d),n.appendChild(h),d.addEventListener("input",a),d.addEventListener("change",a),e.elements=[d],e.set=function(e){d.value=e,h.textContent=e}}function V(e,n){return e===n||e+""==n+""}function G(e,n){return"string"==typeof n&&(n="undefined"!=typeof document?document.querySelector(n):e.error("DOM document instance not found.")),n.innerHTML="",n}function I(e,n){var t=new Blob([e],{type:n});return window.URL.createObjectURL(t)}function B(e,n){var t=e.add(null,function(t){e["_"+n]=t.size,e._autosize=e._resize=1},{size:e._signals[n]});return t.rank=0,t}function W(e,n,t,r,i,a){this.runAfter(function(o){var u=0;o._autosize=0,o.width()!==t&&(u=1,o.width(t),o._resizeWidth.skip(!0)),o.height()!==r&&(u=1,o.height(r),o._resizeHeight.skip(!0)),o._width!==e&&(o._resize=1,o._width=e),o._height!==n&&(o._resize=1,o._height=n),o._origin[0]===i[0]&&o._origin[1]===i[1]||(o._resize=1,o._origin=i),u&&o.run("enter"),a&&o.runAfter(function(){o._autosize=1})})}function N(e){return this._runtime.getState(e||{data:F,signals:J,recurse:!0})}function F(e,n){return n.modified&&r.isArray(n.input.value)&&e.indexOf("_:vega:_")}function J(e,t){return!("parent"===e||t instanceof n.transforms.Proxy)}function K(e){var n=this;return n._trigger=!1,n._runtime.setState(e),n.run().runAfter(function(){n._trigger=!0}),this}function Q(e,r){r=r||{},n.Dataflow.call(this),this.loader(r.loader||this._loader),this.logLevel(r.logLevel||0),this._el=null,this._renderType=r.renderer||t.RenderType.Canvas,this._scenegraph=new t.Scenegraph;var i=this._scenegraph.root;this._renderer=null,this._queue=null,this._handler=(new t.CanvasHandler).scene(i),this._eventListeners=[],this._preventDefault=!0;var a=Ce(this,e,r.functions);this._runtime=a,this._signals=a.signals,this._bind=(e.bindings||[]).map(function(e){return{state:null,param:e}}),a.root&&a.root.set(i),i.source=a.data.root.input,this.pulse(a.data.root.input,this.changeset().insert(i.items)),this._background=a.background||null,this._width=this.width(),this._height=this.height(),this._origin=[0,0],this._resize=0,this._autosize=1,this._resizeWidth=B(this,"width"),this._resizeHeight=B(this,"height"),de(this)}function X(e,n){return e._signals.hasOwnProperty(n)?e._signals[n]:e.error("Unrecognized signal name: "+r.stringValue(n))}var Y=r.inherits(u,n.Transform);Y.transform=function(e,n){var r,i=e.mark,a=i.marktype,o=t.Marks[a],u=o.bound,d=i.bounds;return i.bounds_prev.clear().union(d),o.nested?s(i,u):"group"===a||e.modified()?(d.clear(),i.items.forEach(function(e){d.union(s(e,u))})):(r=n.changed(n.REM),n.visit(n.ADD,function(e){d.union(s(e,u))}),n.visit(n.MOD,function(e){r=r||d.alignsWith(e.bounds),d.union(s(e,u))}),r&&(d.clear(),i.items.forEach(function(e){d.union(e.bounds)}))),n.modifies("bounds")};var Z=r.inherits(d,n.Transform);Z.transform=function(e,n){var r=this.value;r||(r=n.dataflow.scenegraph().mark(e.markdef,h(e),e.index),r.group.context=e.context,e.context.group||(e.context.group=r.group),r.source=this,this.value=r);var i="group"===r.marktype?t.GroupItem:t.Item;return n.visit(n.ADD,function(e){i.call(e,r)}),r.items=n.source,n};var $=r.inherits(c,n.Transform);$.transform=function(e,n){var t=n.dataflow;if(n.changed(n.REM)&&t.enqueue(n.materialize(n.REM).rem),n.changed(n.ADD)&&t.enqueue(n.materialize(n.ADD).add),n.changed(n.MOD)&&t.enqueue(n.materialize(n.MOD).mod),n.fields&&n.fields.zindex){var r=n.source&&n.source[0];r&&(r.mark.zdirty=!0)}};var ee="fit",ne="pad",te="none",re="axis",ie="frame",ae="legend",oe="scope",ue=r.inherits(l,n.Transform);ue.transform=function(e,n){var t=n.dataflow;return e.mark.items.forEach(function(n){f(t,n,e)}),n};var se="default",de=function(e){var n=e._signals.cursor;n||(e._signals.cursor=n=e.add({user:se,item:null})),e.on(e.events("view","mousemove"),n,function(e,t){var i=n.value,a=i?r.isString(i)?i:i.user:se,o=t.item&&t.item.cursor||null;return i&&a===i.user&&o==i.item?i:{user:a,item:o}}),e.add(null,function(e){var n=e.cursor,t=this.value;return r.isString(n)||(t=n.item,n=n.user),y(n&&n!==se?n:t||n),t},{cursor:n})},he=function(e,n,r){var i,a,o,u=e._renderer.element();return u&&(o=S(e),a=n.changedTouches?n.changedTouches[0]:n,i=t.point(a,u),i[0]-=o[0],i[1]-=o[1]),n.vega=L(e,r,i),n.item=r,n},ce="view",le="window",fe=function(e,t,r){var i,a=this,o=new n.EventStream(r),u=function(n,t){a.preventDefault()&&e===ce&&n.preventDefault(),o.receive(he(a,n,t)),a.run()};if(e===ce)return a.addEventListener(t,u),o;if(e===le?"undefined"!=typeof window&&(i=[window]):"undefined"!=typeof document&&(i=document.querySelectorAll(e)),!i)return a.warn("Can not resolve event source: "+e),o;for(var s=0,d=i.length;s<d;++s)i[s].addEventListener(t,u);return a._eventListeners.push({type:t,sources:i,handler:u}),o},ge=function(e,n){return this.on(this.events("view","mouseover",q),D,A(e||"hover")),this.on(this.events("view","mouseout",q),D,A(n||"update")),this},ve=function(){for(var e,n,t=this._eventListeners,r=t.length;--r>=0;)for(n=t[r],e=n.sources.length;--e>=0;)n.sources[e].removeEventListener(n.type,n.handler)},pe=function(e,n,t){var r=document.createElement(e);for(var i in n)r.setAttribute(i,n[i]);return null!=t&&(r.textContent=t),r},me="vega-bind",_e="vega-bind-name",be="vega-bind-radio",ye="vega-option-",ke=function(e,n,t){var i=t.param,a=t.state||(t.state={elements:null,set:null,update:function(n){a.source=!0,e.signal(i.signal,n).run()},active:!1});return r.isString(n)&&(n=document.querySelector(n)),R(a,n,i,e.signal(i.signal)),a.active||(e.on(e._signals[i.signal],null,function(){a.source?a.source=!1:a.set(e.signal(i.signal))}),a.active=!0),a},xe=function(e,n,t,r){return n=n||new r(e.loader()),n.initialize(t,T(e),E(e),S(e)).background(e._background)},we=function(e,n,t,r){var i=(new r).scene(e.scenegraph().root).initialize(t,S(e),e);return n&&(i.handleTooltip=n.handleTooltip,n.handlers().forEach(function(e){i.on(e.type,e.handler)})),i},ze=function(e,n){var r,i,a=this,o=a._renderType,u=t.renderModule(o);return e=a._el=e?G(a,e):null,u||a.error("Unrecognized renderer type: "+o),r=u.handler||t.CanvasHandler,i=e?u.renderer:u.headless,a._renderer=i?xe(a,a._renderer,e,i):null,a._handler=we(a,a._handler,e,r),e&&(n=n?G(a,n):e.appendChild(pe("div",{class:"vega-bindings"})),a._bind.forEach(function(e){ke(a,e.param.element||n,e)})),a},Me=function(e,n){var r=t.renderModule(n);return r&&r.headless?e.runAsync().then(function(){return xe(e,null,null,r.headless).renderAsync(e._scenegraph.root)}):Promise.reject("Unrecognized renderer type: "+n)},Te=function(e){return e!==t.RenderType.Canvas&&e!==t.RenderType.SVG&&e!==t.RenderType.PNG?Promise.reject("Unrecognized image type: "+e):Me(this,e).then(function(n){return e===t.RenderType.SVG?I(n.svg(),"image/svg+xml"):n.canvas().toDataURL("image/png")})},Ee=function(){return Me(this,t.RenderType.Canvas).then(function(e){return e.canvas()})},Se=function(){return Me(this,t.RenderType.SVG).then(function(e){return e.svg()})},Ce=function(e,t,r){var i=r||a.functionContext;return o.parse(t,o.context(e,n.transforms,i))},Le=r.inherits(Q,n.Dataflow);Le.run=function(e){n.Dataflow.prototype.run.call(this,e);var t=this._queue;return(this._resize||!t||t.length)&&(this.render(t),this._queue=[]),this},Le.render=function(e){return this._renderer&&(this._resize&&(this._resize=0,C(this)),this._renderer.render(this._scenegraph.root,e)),this},Le.enqueue=function(e){this._queue&&e&&e.length&&(this._queue=this._queue.concat(e))},Le.signal=function(e,n,t){var r=X(this,e);return 1===arguments.length?r.value:this.update(r,n,t)},Le.scenegraph=function(){return this._scenegraph},Le.background=function(e){return arguments.length?(this._background=e,this._resize=1,this):this._background},Le.width=function(e){return arguments.length?this.signal("width",e):this.signal("width")},Le.height=function(e){return arguments.length?this.signal("height",e):this.signal("height")},Le.padding=function(e){return arguments.length?this.signal("padding",e):this.signal("padding")},Le.renderer=function(e){return arguments.length?(t.renderModule(e)||this.error("Unrecognized renderer type: "+e),e!==this._renderType&&(this._renderType=e,this._renderer&&(this._renderer=this._queue=null,this.initialize(this._el))),this):this._renderType},Le.loader=function(e){return arguments.length?(e!==this._loader&&(n.Dataflow.prototype.loader.call(this,e),this._renderer&&(this._renderer=this._queue=null,this.initialize(this._el))),this):this._loader},Le.addEventListener=function(e,n){this._handler.on(e,n)},Le.removeEventListener=function(e,n){this._handler.off(e,n)},Le.addSignalListener=function(e,n){var t=X(this,e),r=function(){n(e,t.value)};this.on(t,null,(r.handler=n,r))},Le.removeSignalListener=function(e,n){var t=X(this,e),r=t._targets||[],i=r.filter(function(e){var t=e._update;return t&&t.handler===n});i.length&&r.remove(i[0])},Le.preventDefault=function(e){return arguments.length?(this._preventDefault=e,this):this._preventDefault},Le.tooltipHandler=function(e){var n=this._handler;return arguments.length?(n.handleTooltip=e||t.Handler.prototype.handleTooltip,this):n.handleTooltip},Le.events=fe,Le.finalize=ve,Le.hover=ge,Le.autosize=W,Le.data=x,Le.change=w,Le.insert=z,Le.remove=M,Le.initialize=ze,Le.toImageURL=Te,Le.toCanvas=Ee,Le.toSVG=Se,Le.getState=N,Le.setState=K,n.transform("Bound",u),n.transform("Mark",d),n.transform("Render",c),n.transform("ViewLayout",l),e.View=Q,Object.defineProperty(e,"__esModule",{value:!0})});