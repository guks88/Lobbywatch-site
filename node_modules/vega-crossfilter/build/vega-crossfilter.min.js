!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("vega-dataflow"),require("d3-array"),require("vega-util")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","d3-array","vega-util"],r):r(e.vega=e.vega||{},e.vega,e.d3,e.vega)}(this,function(e,r,n,i){"use strict";function t(e){return new Uint8Array(e)}function a(e){return new Uint16Array(e)}function o(e){return new Uint32Array(e)}function f(){var e=8,r=[],n=o(0),i=s(0,e),t=s(0,e);return{data:function(){return r},seen:function(){return n=u(n,r.length)},add:function(e){for(var n,i=0,t=r.length,a=e.length;i<a;++i)n=e[i],n._index=t++,r.push(n)},remove:function(e,n){var a,o,f,u=r.length,s=Array(u-e),d=r;for(o=0;!n[o]&&o<u;++o)s[o]=r[o],d[o]=o;for(f=o;o<u;++o)a=r[o],n[o]?d[o]=-1:(d[o]=f,i[f]=i[o],t[f]=t[o],s[f]=a,a._index=f++),i[o]=0;return r=s,d},size:function(){return r.length},curr:function(){return i},prev:function(){return t},reset:function(e){t[e]=i[e]},all:function(){return e<257?255:e<65537?65535:4294967295},set:function(e,r){i[e]|=r},clear:function(e,r){i[e]&=~r},resize:function(r,n){var a=i.length;(r>a||n>e)&&(e=Math.max(n,e),i=s(r,e,i),t=s(r,e))}}}function u(e,r,n){return e.length>=r?e:(n=n||new e.constructor(r),n.set(e),n)}function s(e,r,n){var i=(r<257?t:r<65537?a:o)(e);return n&&i.set(n),i}function d(){function e(e,r,n){if(!r.length)return[];var i,t,s,d=u,h=r.length,m=Array(h),v=o(h);for(s=0;s<h;++s)m[s]=e(r[s]),v[s]=s;if(m=l(m,v),d)i=f,t=a,f=Array(d+h),a=o(d+h),c(n,i,t,d,m,v,h,f,a);else{if(n>0)for(s=0;s<h;++s)v[s]+=n;f=m,a=v}return u=d+h,{index:v,value:m}}function r(e,r){var n,i,t,o=u;for(i=0;!r[a[i]]&&i<o;++i);for(t=i;i<o;++i)r[n=a[i]]||(a[t]=n,f[t]=f[i],++t);u=o-e}function i(e){for(var r=0,n=u;r<n;++r)a[r]=e[a[r]]}function t(e,r){var i=r?r.length:(r=f,u);return[n.bisectLeft(r,e[0],0,i),n.bisectRight(r,e[1],0,i)]}var a=o(0),f=[],u=0;return{insert:e,remove:r,bisect:t,reindex:i,index:function(){return a},size:function(){return u}}}function l(e,r){return e.sort.call(r,function(r,n){var i=e[r],t=e[n];return i<t?-1:i>t?1:0}),n.permute(e,r)}function c(e,r,n,i,t,a,o,f,u){var s,d=0,l=0;for(s=0;d<i&&l<o;++s)r[d]<t[l]?(f[s]=r[d],u[s]=n[d++]):(f[s]=t[l],u[s]=a[l++]+e);for(;d<i;++d,++s)f[s]=r[d],u[s]=n[d];for(;l<o;++l,++s)f[s]=t[l],u[s]=a[l]+e}function h(e){r.Transform.call(this,f(),e),this._indices=null,this._dims=null}function m(e){r.Transform.call(this,null,e)}var v=function(e,r,n){var i=1<<r;return{one:i,zero:~i,range:n.slice(),bisect:e.bisect,index:e.index,size:e.size,onAdd:function(e,r){var n,t=this,a=t.bisect(t.range,e.value),o=e.index,f=a[0],u=a[1],s=o.length;for(n=0;n<f;++n)r[o[n]]|=i;for(n=u;n<s;++n)r[o[n]]|=i;return t}}},g=i.inherits(h,r.Transform);g.transform=function(e,r){if(this._dims){var n=e.modified("fields")||e.fields.some(function(e){return r.modified(e.fields)});return n?this.reinit(e,r):this.eval(e,r)}return this.init(e,r)},g.init=function(e,r){for(var n,i,t=e.fields,a=e.query,o=this._indices={},f=this._dims=[],u=a.length,s=0;s<u;++s)n=t[s].fname,i=o[n]||(o[n]=d()),f.push(v(i,s,a[s]));return this.eval(e,r)},g.reinit=function(e,r){var n,i,t,a,o,f,u,s,l,c=r.materialize().fork(),h=e.fields,m=e.query,g=this._indices,p=this._dims,y=this.value,x=y.curr(),_=y.prev(),b=y.all(),A=c.rem=c.add,q=c.mod,M=m.length,z={};if(_.set(x),r.rem.length&&(o=this.remove(e,r,c)),r.add.length&&y.add(r.add),r.mod.length)for(f={},a=r.mod,u=0,s=a.length;u<s;++u)f[a[u]._index]=1;for(u=0;u<M;++u)l=h[u],(!p[u]||e.modified("fields",u)||r.modified(l.fields))&&(t=l.fname,(n=z[t])||(g[t]=i=d(),z[t]=n=i.insert(l,r.source,0)),p[u]=v(i,u,m[u]).onAdd(n,x));for(u=0,s=y.data().length;u<s;++u)o[u]||(_[u]!==x[u]?A.push(u):f[u]&&x[u]!==b&&q.push(u));return y.mask=(1<<M)-1,c},g.eval=function(e,r){var n=r.materialize().fork(),i=this._dims.length,t=0;return r.rem.length&&(this.remove(e,r,n),t|=(1<<i)-1),e.modified("query")&&!e.modified("fields")&&(t|=this.update(e,r,n)),r.add.length&&(this.insert(e,r,n),t|=(1<<i)-1),r.mod.length&&(this.modify(r,n),t|=(1<<i)-1),this.value.mask=t,n},g.insert=function(e,r,n){var i,t,a,o=r.add,f=this.value,u=this._dims,s=this._indices,d=e.fields,l={},c=n.add,h=f.size(),m=h+o.length,v=u.length;f.resize(m,v),f.add(o);var g=f.curr(),p=f.prev(),y=f.all();for(i=0;i<v;++i)t=d[i].fname,a=l[t]||(l[t]=s[t].insert(d[i],o,h)),u[i].onAdd(a,g);for(;h<m;++h)p[h]=y,g[h]!==y&&c.push(h)},g.modify=function(e,r){var n,i,t,a=r.mod,o=this.value,f=o.curr(),u=o.all(),s=e.mod;for(n=0,i=s.length;n<i;++n)t=s[n]._index,f[t]!==u&&a.push(t)},g.remove=function(e,r,n){var i,t,a,o,f=this._indices,u=this.value,s=u.curr(),d=u.prev(),l=u.all(),c={},h=n.rem,m=r.rem;for(i=0,t=m.length;i<t;++i)a=m[i]._index,c[a]=1,d[a]=o=s[a],s[a]=l,o!==l&&h.push(a);for(a in f)f[a].remove(t,c);return this.reindex(r,t,c),c},g.reindex=function(e,r,n){var i=this._indices,t=this.value;e.runAfter(function(){var e=t.remove(r,n);for(var a in i)i[a].reindex(e)})},g.update=function(e,r,n){var i,t,a=this._dims,o=e.query,f=r.stamp,u=a.length,s=0;for(n.filters=0,t=0;t<u;++t)e.modified("query",t)&&(i=t,++s);if(1===s)s=a[i].one,this.incrementOne(a[i],o[i],n.add,n.rem);else for(t=0,s=0;t<u;++t)e.modified("query",t)&&(s|=a[t].one,this.incrementAll(a[t],o[t],f,n.add),n.rem=n.add);return s},g.incrementAll=function(e,r,n,i){var t,a,o,f=this.value,u=f.seen(),s=f.curr(),d=f.prev(),l=e.index(),c=e.bisect(e.range),h=e.bisect(r),m=h[0],v=h[1],g=c[0],p=c[1],y=e.one;if(m<g)for(t=m,a=Math.min(g,v);t<a;++t)o=l[t],u[o]!==n&&(d[o]=s[o],u[o]=n,i.push(o)),s[o]^=y;else if(m>g)for(t=g,a=Math.min(m,p);t<a;++t)o=l[t],u[o]!==n&&(d[o]=s[o],u[o]=n,i.push(o)),s[o]^=y;if(v>p)for(t=Math.max(m,p),a=v;t<a;++t)o=l[t],u[o]!==n&&(d[o]=s[o],u[o]=n,i.push(o)),s[o]^=y;else if(v<p)for(t=Math.max(g,v),a=p;t<a;++t)o=l[t],u[o]!==n&&(d[o]=s[o],u[o]=n,i.push(o)),s[o]^=y;e.range=r.slice()},g.incrementOne=function(e,r,n,i){var t,a,o,f=this.value,u=f.curr(),s=e.index(),d=e.bisect(e.range),l=e.bisect(r),c=l[0],h=l[1],m=d[0],v=d[1],g=e.one;if(c<m)for(t=c,a=Math.min(m,h);t<a;++t)o=s[t],u[o]^=g,n.push(o);else if(c>m)for(t=m,a=Math.min(c,v);t<a;++t)o=s[t],u[o]^=g,i.push(o);if(h>v)for(t=Math.max(c,v),a=h;t<a;++t)o=s[t],u[o]^=g,n.push(o);else if(h<v)for(t=Math.max(m,h),a=v;t<a;++t)o=s[t],u[o]^=g,i.push(o);e.range=r.slice()};var p={type:"CrossFilter",metadata:{},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"query",type:"array",array:!0,required:!0,content:{type:"number",array:!0,length:2}}]},y=i.inherits(m,r.Transform);y.transform=function(e,r){var n=~(e.ignore||0),i=e.filter,t=i.mask;if(0===(t&n))return r.StopPropagation;var a=r.fork(r.ALL),o=i.data(),f=i.curr(),u=i.prev(),s=function(e){return f[e]&n?null:o[e]};return a.filter(a.MOD,s),t&t-1?(a.filter(a.ADD,function(e){var r=f[e]&n,i=!r&&r^u[e]&n;return i?o[e]:null}),a.filter(a.REM,function(e){var r=f[e]&n,i=r&&!(r^(r^u[e]&n));return i?o[e]:null})):(a.filter(a.ADD,s),a.filter(a.REM,function(e){return(f[e]&n)===t?o[e]:null})),a.filter(a.SOURCE,function(e){return s(e._index)})};var x={type:"ResolveFilter",metadata:{},params:[{name:"ignore",type:"number",required:!0,description:"A bit mask indicating which filters to ignore."},{name:"filter",type:"object",required:!0,description:"Per-tuple filter bitmaps from a CrossFilter transform."}]};r.register(p,h),r.register(x,m),e.transform=r.transform,e.definition=r.definition,Object.defineProperty(e,"__esModule",{value:!0})});